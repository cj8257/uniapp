"use strict";const e=require("../../common/vendor.js"),a={data:()=>({form:{username:"",password:""},rememberPassword:!1,loading:!1,loginStatus:"",statusText:""}),methods:{async handleLogin(){if(!this.form.username||!this.form.password)return this.loginStatus="error",void(this.statusText="请输入用户名和密码");this.loading=!0;try{const a=await this.$api.user_login(this.form);console.log(a),this.rememberPassword?(e.index.setStorageSync("savedUsername",this.form.username),e.index.setStorageSync("savedPassword",this.form.password)):(e.index.removeStorageSync("savedUsername"),e.index.removeStorageSync("savedPassword"));const s={avatar:a.data.data[0].avatar||"/static/user/默认.webp",nickname:a.data.data[0].username,department:a.data.data[0].department,role:a.data.data[0].role,phone:a.data.data[0].phone,username:a.data.data[0].username};e.index.setStorageSync("token","mock-token"),e.index.setStorageSync("userInfo",s),e.index.showModal({title:"用户信息收集说明",content:"为了给您提供更好的服务，我们需要收集您的以下信息：\n\n1. 头像：用于在系统中显示您的个人头像\n2. 昵称：用于在系统中显示您的名称\n\n这些信息仅用于系统内部使用，我们承诺不会将您的信息用于其他用途或提供给第三方。\n\n您是否同意授权我们收集这些信息？",confirmText:"同意",cancelText:"拒绝",success:async a=>{if(a.confirm)try{const a=await e.index.getUserProfile({desc:"用于完善用户资料，提供个性化服务"}),t={...s,avatar:a.userInfo.avatarUrl||s.avatar,nickname:a.userInfo.nickName||s.nickname};e.index.setStorageSync("userInfo",t)}catch(t){console.log("用户拒绝授权",t)}e.index.switchTab({url:"/pages/my/my"})}})}catch(a){this.loginStatus="error",this.statusText="登录失败，请重试"}finally{this.loading=!1}},handleRememberChange(e){this.rememberPassword=e.detail.value.length>0},goToReset(){e.index.navigateTo({url:"/pages/login/reset-password"})}},onLoad(){const a=e.index.getStorageSync("savedUsername"),s=e.index.getStorageSync("savedPassword");a&&s&&(this.form.username=a,this.form.password=s,this.rememberPassword=!0)}};const s=e._export_sfc(a,[["render",function(a,s,t,r,n,o){return{a:n.form.username,b:e.o((e=>n.form.username=e.detail.value)),c:n.form.password,d:e.o((e=>n.form.password=e.detail.value)),e:n.rememberPassword,f:e.o(((...e)=>o.handleRememberChange&&o.handleRememberChange(...e))),g:e.o(((...e)=>o.goToReset&&o.goToReset(...e))),h:e.o(((...e)=>o.handleLogin&&o.handleLogin(...e))),i:n.loading,j:e.t(n.statusText),k:"error"===n.loginStatus?1:""}}]]);wx.createPage(s);
