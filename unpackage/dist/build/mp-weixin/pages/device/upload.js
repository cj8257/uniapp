"use strict";const e=require("../../common/vendor.js"),t={data:()=>({formData:{name:"",code:"",type:"",status:"available",image:"",description:"",purchaseDate:"",lastMaintenanceDate:"",nextMaintenanceDate:"",price:"",location:"",manufacturer:"",model:"",specification:"",serialNumber:"",warrantyPeriod:"",maintenanceCycle:"",lastMaintenanceContent:"",nextMaintenanceContent:"",remark:"",phone:"",username:""},deviceTypes:["办公设备","电子设备","家具","其他"],statusTypes:["可用","已借出","维护中","已报废"],selectedType:"",selectedStatus:"",imageList:[],isEdit:!1,editId:""}),onLoad(t){if("edit"===t.mode&&t.data)try{const e=JSON.parse(decodeURIComponent(t.data));this.isEdit=!0,this.editId=e._id,this.formData={...this.formData,...e,purchaseDate:e.purchaseDate||"",lastMaintenanceDate:e.lastMaintenanceDate||"",nextMaintenanceDate:e.nextMaintenanceDate||""},this.selectedType=e.type,this.selectedStatus=this.getStatusText(e.status),e.image&&(this.imageList=[e.image])}catch(a){console.error("解析编辑数据失败:",a),e.index.showToast({title:"数据加载失败",icon:"none"})}},methods:{handleTypeChange(e){this.selectedType=this.deviceTypes[e.detail.value]},handleStatusChange(e){this.formData.status=e.detail.value},chooseImage(){e.index.chooseImage({count:1,success:async e=>{this.formData.image=e.tempFilePaths[0],console.log(e);let t=Math.random().toString(36).substring(2,15)+".jpg";const a=await this._uploadFile(e.tempFilePaths[0],t);this.formData.url=a}})},async _uploadFile(t,a){const{fileID:i}=await e.nr.uploadFile({filePath:t,cloudPath:`device/${a}`,cloudPathAsRealPath:!0});return i},async handleSubmit(){if(this.validateForm())try{const t={...this.formData,type:this.selectedType,status:this.getStatusValue(this.selectedStatus)};delete t.isSlide,this.isEdit?(await this.$api.device_upload({...t,_id:this.editId,isEdit:!0}),e.index.showToast({title:"更新成功",icon:"success"})):(await this.$api.device_upload(t),e.index.showToast({title:"添加成功",icon:"success"})),setTimeout((()=>{e.index.navigateBack()}),1500)}catch(t){console.error("提交失败:",t),e.index.showToast({title:this.isEdit?"更新失败":"添加失败",icon:"none"})}},getStatusText:e=>({available:"可用",borrowed:"已借出",maintenance:"维护中",scrapped:"已报废"}[e]||e),getStatusValue:e=>({"可用":"available","已借出":"borrowed","维护中":"maintenance","已报废":"scrapped"}[e]||"available"),validateForm(){return this.formData.name?this.selectedType?!!this.formData.code||(e.index.showToast({title:"请输入设备编号",icon:"none"}),!1):(e.index.showToast({title:"请选择设备类型",icon:"none"}),!1):(e.index.showToast({title:"请输入设备名称",icon:"none"}),!1)}}};const a=e._export_sfc(t,[["render",function(t,a,i,s,n,o){return e.e({a:e.t(n.isEdit?"编辑设备":"添加设备"),b:n.formData.name,c:e.o((e=>n.formData.name=e.detail.value)),d:e.t(n.selectedType||"请选择设备类型"),e:n.deviceTypes,f:e.o(((...e)=>o.handleTypeChange&&o.handleTypeChange(...e))),g:n.formData.code,h:e.o((e=>n.formData.code=e.detail.value)),i:n.formData.url},n.formData.url?{j:n.formData.url}:{},{k:e.o(((...e)=>o.chooseImage&&o.chooseImage(...e))),l:n.formData.description,m:e.o((e=>n.formData.description=e.detail.value)),n:"available"===n.formData.status,o:"borrowed"===n.formData.status,p:"maintenance"===n.formData.status,q:"scrapped"===n.formData.status,r:e.o(((...e)=>o.handleStatusChange&&o.handleStatusChange(...e))),s:e.o(((...e)=>o.handleSubmit&&o.handleSubmit(...e)))})}]]);wx.createPage(a);
