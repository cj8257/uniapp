"use strict";const e=require("../../common/vendor.js"),t={data:()=>({deviceTypes:["全部","办公设备","电子设备","家具","其他"],statusTypes:["全部","可用","已借出","维护中","已报废"],selectedType:"全部",selectedStatus:"全部",totalDevices:0,borrowedDevices:0,availableDevices:0,overdueDevices:0,devices:[],searchKeyword:"",startX:0,moveX:0,currentIndex:""}),methods:{touchStart(e,t){this.startX=e.touches[0].clientX,this.currentIndex=t},touchMove(e,t){this.currentIndex===t&&(this.moveX=e.touches[0].clientX-this.startX,this.moveX<0?this.$set(this.devices[t],"isSlide",!0):this.$set(this.devices[t],"isSlide",!1))},touchEnd(e,t){this.currentIndex===t&&(this.moveX<-50?this.$set(this.devices[t],"isSlide",!0):this.$set(this.devices[t],"isSlide",!1),this.currentIndex=-1)},async handleDelete(t){let a=this;e.index.showModal({title:"确认删除",content:"确定要删除该设备吗？",success:async s=>{if(s.confirm)try{await a.$api.device_delete({id:t._id}),e.index.showToast({title:"删除成功",icon:"success"}),a.fetchDevices()}catch(i){e.index.showToast({title:"删除失败",icon:"error"})}}})},handleSearch(e){this.filterDevices()},handleClear(){this.searchKeyword="",this.filterDevices()},filterDevices(){this.searchKeyword?this.devices=this.devices.filter((e=>e.name.toLowerCase().includes(this.searchKeyword.toLowerCase())||e.code.toLowerCase().includes(this.searchKeyword.toLowerCase()))):this.fetchDevices()},updateStatistics(){this.totalDevices=this.devices.length,this.borrowedDevices=this.devices.filter((e=>"borrowed"===e.status)).length,this.availableDevices=this.devices.filter((e=>"available"===e.status)).length,this.overdueDevices=this.devices.filter((e=>e.nextMaintenanceDate<new Date)).length},async handleTypeChange(e){await this.fetchDevices(),this.selectedType=this.deviceTypes[e.detail.value],this.devices=this.devices.filter((e=>!("全部"!==this.selectedType&&e.type!==this.selectedType||"全部"!==this.selectedStatus&&this.getStatusText(e.status)!==this.selectedStatus)))},async handleStatusChange(e){await this.fetchDevices(),this.selectedStatus=this.statusTypes[e.detail.value],this.devices=this.devices.filter((e=>!("全部"!==this.selectedType&&e.type!==this.selectedType||"全部"!==this.selectedStatus&&this.getStatusText(e.status)!=this.selectedStatus)))},getStatusText:e=>({available:"可用",borrowed:"已借出",maintenance:"维护中",scrapped:"已报废"}[e]||e),formatDate:e=>new Date(e).toLocaleDateString(),async fetchDevices(){const{data:e}=await this._deviceAll();console.log(e),this.totalDevices=e.length,this.borrowedDevices=e.filter((e=>"borrowed"===e.status)).length,this.availableDevices=e.filter((e=>"available"===e.status)).length,this.overdueDevices=e.filter((e=>e.nextMaintenanceDate&&new Date(e.nextMaintenanceDate)<new Date)).length,this.devices=e,console.log(this.devices)},async _deviceAll(){return await this.$api.device_all({})},previewImage(t){e.index.previewImage({urls:[t],current:t})},handleEdit(t){const a={...t,purchaseDate:t.purchaseDate?new Date(t.purchaseDate).toISOString().split("T")[0]:"",lastMaintenanceDate:t.lastMaintenanceDate?new Date(t.lastMaintenanceDate).toISOString().split("T")[0]:"",nextMaintenanceDate:t.nextMaintenanceDate?new Date(t.nextMaintenanceDate).toISOString().split("T")[0]:""};e.index.navigateTo({url:`/pages/device/upload?mode=edit&data=${encodeURIComponent(JSON.stringify(a))}`}),this.currentIndex=""}},onShow(){this.fetchDevices()}};const a=e._export_sfc(t,[["render",function(t,a,s,i,n,c){return e.e({a:e.t(n.totalDevices),b:e.t(n.borrowedDevices),c:e.t(n.availableDevices),d:e.t(n.overdueDevices),e:e.o(((...e)=>c.handleSearch&&c.handleSearch(...e))),f:e.o([e=>n.searchKeyword=e.detail.value,(...e)=>c.handleSearch&&c.handleSearch(...e)]),g:n.searchKeyword,h:n.searchKeyword},n.searchKeyword?{i:e.o(((...e)=>c.handleClear&&c.handleClear(...e)))}:{},{j:e.t(n.selectedType||"全部"),k:n.deviceTypes,l:e.o(((...e)=>c.handleTypeChange&&c.handleTypeChange(...e))),m:e.t(n.selectedStatus||"全部"),n:n.statusTypes,o:e.o(((...e)=>c.handleStatusChange&&c.handleStatusChange(...e))),p:e.f(n.devices,((t,a,s)=>e.e({a:t.nextMaintenanceDate&&new Date(t.nextMaintenanceDate)<new Date},(t.nextMaintenanceDate&&new Date(t.nextMaintenanceDate),{}),{b:"available"===t.status},(t.status,{}),{c:"borrowed"===t.status&&(!t.nextMaintenanceDate||new Date(t.nextMaintenanceDate)>=new Date)},("borrowed"===t.status&&(!t.nextMaintenanceDate||new Date(t.nextMaintenanceDate)),{}),{d:t.url||t.image,e:e.o((e=>c.previewImage(t.image)),a),f:e.t(t.name),g:e.t(t.code),h:e.t(t.type),i:e.t(c.getStatusText(t.status)),j:e.n(t.status),k:e.t(t.username),l:t.lastMaintenanceDate},t.lastMaintenanceDate?{m:e.t(c.formatDate(t.nextMaintenanceDate))}:{},{n:e.o((e=>c.touchStart(e,a)),a),o:e.o((e=>c.touchMove(e,a)),a),p:e.o((e=>c.touchEnd(e,a)),a),q:e.o((e=>c.handleDelete(t)),a),r:e.o((e=>c.handleEdit(t)),a),s:a,t:t.isSlide?1:"",v:t.nextMaintenanceDate&&new Date(t.nextMaintenanceDate)<new Date?1:"",w:"available"===t.status?1:"",x:"borrowed"===t.status&&(!t.nextMaintenanceDate||new Date(t.nextMaintenanceDate)>=new Date)?1:""}))),q:0===n.devices.length},(n.devices.length,{}))}]]);wx.createPage(a);
